import express from "express";
import admin from "firebase-admin";
import path from "path";
import { fileURLToPath } from "url";

// Ù„Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¹Ù„Ù‰ UTC
process.env.TZ = 'UTC';

// Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
const app = express();
const port = process.env.PORT || 3000;

// âœ… Ø¥Ø¶Ø§ÙØ© middleware Ù„ØªØ­Ù„ÙŠÙ„ JSON
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// âœ… Firebase Ø¥Ø¹Ø¯Ø§Ø¯
admin.initializeApp({
  credential: admin.credential.cert({
    projectId: "freefirerewardsdz-69572",
    clientEmail: "firebase-adminsdk-fbsvc@freefirerewardsdz-69572.iam.gserviceaccount.com",
    privateKey: `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCdxbOc5RFjmNN4
IIqTZSnHkW+THjkcfZvMt1Nz2b3O8YTJMQG7xVkRY10TKpvwPy7KFA4/U7QdXJf7
cw11wrBUh8EKtg+vfQaC/lGFVzeNr2wCGB96NIlScF1TmcQWU7YQqGd6u4YirTrH
NOj/aDr57HEH9zCcndBFYpJV5YCGgm1uUeo/ui2OPnSsy6+xcTtY9pC1kj7YcyLh
Mu/j8mGsLgX8oxAFqvijYurgEAXFXEym3sXPx5LwVHvGPUwEDvTSmgj4I1aPKt1k
5TaTlwnV+hbIqovFr0B+vJmTWLv0N44PVqD2JmV1htK/+wgVnSmsbEww3tqo8Y1+
NzmNIuUNAgMBAAECggEAFe8orakWDg3u5m5FvcCseouQYrhqsbiPyrn4/uv4bLcc
ohjvWALTg2yYQcQkelXaZCs+INU6/vMCySlBZ4wJ1jKqZpoRm7Dq0RbY0AwkU80d
27utUqDPr5eiDe+ceIsqTm4PNtuvxg3l1FCZjPqZamoR+8zEpB13mVHfLNRzlh9/
ZrJbzaP4A0JyESTaKHg9VI5R5i0FSkq87VTA1O/rqY3VTB8vvlDKlREGOcPplJ2c
iaK++XOXdSCbDWizXh9PPjb4rV9zzSctif7QLY9QoK02oz4CILqCIdI+FEMQZF3/
gtLBZRxbwIavHkc5HZ7VMYGo6ge00BJzPvHB1agJ0QKBgQDWTqthpFA4YyMcFtXO
06lSQIG9V6ghEFVuSAy/fapURrLa2ysLv06jwoV7PIJhS/MmaxBXtDFwTnCHtTrG
HmDAJsC7PtiQzwf2C0KBlklqylcIzOs+deGKN3qkfAKZSrh2/yFmMsKB8OIguCiY
Z3Agn8Y4ocPrt2YickHofUaGXQKBgQC8d16XRhipToZAæžé€Ÿ4.0
-----END PRIVATE KEY-----`,
  }),
  databaseURL: "https://freefirerewardsdz-69572-default-rtdb.firebaseio.com"
});

console.log("âœ… Firebase initialized successfully.");

// Ù…Ù„ÙØ§Øª HTML Ø£Ùˆ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø«Ø§Ø¨ØªØ©
app.use(express.static(__dirname));

// Ù‚Ø§Ø¦Ù…Ø© IPs Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©
const ALLOWED_IPS = {
  MYLEAD: [
    '52.31.137.75', '52.49.173.169', '52.214.14.220', // MyLead IPs
  ],
  ADGEM: [
    '35.185.125.13', '35.185.126.53', // AdGem IPs
  ],
  LOCAL: [
    '127.0.0.1', '::1', '::ffff:127.0.0.1', // Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
    '0.0.0.0' // Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Render
  ]
};

// âœ… Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ IP
function getCleanIp(req) {
  let ip = req.ip || req.connection.remoteAddress;
  
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ IP Ù…Ù† Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø§Øª
  if (ip.startsWith('::ffff:')) {
    ip = ip.substring(7);
  }
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ÙØ° Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  if (ip.includes(':')) {
    ip = ip.split(':')[0];
  }
  
  return ip;
}

// âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† IP Ø§Ù„Ù…ØµØ¯Ø±
function checkAllowedIP(clientIP, platform) {
  const allowedIPs = [...ALLOWED_IPS[platform], ...ALLOWED_IPS.LOCAL];
  return allowedIPs.includes(clientIP);
}

// âœ… Ù†Ù‚Ø·Ø© postback Ù„Ø¯Ø¹Ù… MyLead (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±)
app.get("/postback", async (req, res) => {
  const { transaction_id, program_name, payout, ml_sub1, player_id, status } = req.query;

  console.log("ðŸ“© Postback received from MyLead:", req.query);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† IP Ø§Ù„Ù…ØµØ¯Ø±
  const clientIP = getCleanIp(req);
  if (!checkAllowedIP(clientIP, 'MYLEAD')) {
    console.warn(`âŒ IP ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù€ MyLead: ${clientIP}`);
    return res.status(403).send("ØºÙŠØ± Ù…ØµØ±Ø­");
  }

  console.log(`âœ… IP Ù…Ø³Ù…ÙˆØ­ Ù„Ù€ MyLead: ${clientIP}`);

  // Ù†Ø­Ø¯Ø¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙˆØ§Ø¡ Ø¬Ø§ÙŠ Ù…Ù† MyLead Ø£Ùˆ AdGem
  const autoUserId = ml_sub1 || player_id;

  if (!autoUserId || !payout) {
    console.warn("âŒ Missing userId or payout");
    return res.status(400).send("Missing userId or payout");
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
  if (status && status !== "approved") {
    console.warn(`âŒ Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©: ${status}`);
    return res.status(400).send("Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©");
  }

  try {
    const db = admin.database();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
    if (transaction_id) {
      const existingTxRef = db.ref(`transactions/${transaction_id}`);
      const existingTx = await existingTxRef.once('value');
      
      if (existingTx.exists()) {
        console.log(`âš ï¸ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙƒØ±Ø±Ø©: ${transaction_id}`);
        return res.status(200).send("Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙƒØ±Ø±Ø© - ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§");
      }
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const userMappingsRef = db.ref('userMappings');
    const snapshot = await userMappingsRef.orderByChild('autoGeneratedId').equalTo(autoUserId).once('value');
    
    if (!snapshot.exists()) {
      console.warn(`âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: ${autoUserId}`);
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© pending Ø­ØªÙ‰ ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨
      if (transaction_id) {
        const pendingTxRef = db.ref(`pendingTransactions/${transaction_id}`);
        await pendingTxRef.set({
          transaction_id,
          program_name,
          payout,
          autoUserId,
          timestamp: Date.now(),
          status: "pending_user_linking",
          source: "mylead"
        });
        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© pending: ${transaction_id}`);
      }
      
      return res.status(404).send("User mapping not found");
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ
    let googleUserId = null;
    snapshot.forEach((childSnapshot) => {
      googleUserId = childSnapshot.key;
    });
    
    if (!googleUserId) {
      return res.status(404).send("Google user ID not found");
    }

    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„
    const userRef = db.ref(`users/${googleUserId}`);
    const pointsSnapshot = await userRef.child("points").once("value");
    const pointsToAdd = Math.round(parseFloat(payout) * 300);
    const newPoints = (pointsSnapshot.val() || 0) + pointsToAdd;

    await userRef.update({ points: newPoints });

    console.log(`âœ… Added ${pointsToAdd} points to ${googleUserId} (Total: ${newPoints})`);

    // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ³ØªØ¨Ø§Ùƒ ÙÙŠ transactions
    const txId = transaction_id || "mylead_no_id_" + Date.now();
    const txRef = db.ref(`transactions/${txId}`);
    await txRef.set({
      transaction_id,
      program_name,
      payout,
      autoUserId,
      googleUserId,
      points: pointsToAdd,
      timestamp: Date.now(),
      status: "completed",
      ip: clientIP,
      source: "mylead"
    });

    console.log(`âœ… ØªÙ… ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø§Ù…Ù„Ø© MyLead: ${txId}`);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù†Ø§Ø¬Ø­ Ø¥Ù„Ù‰ MyLead
    res.status(200).send("OK");

  } catch (error) {
    console.error("âŒ MyLead Postback Error:", error);
    res.status(500).send("Error processing postback");
  }
});

// âœ… Ù†Ù‚Ø·Ø© postback Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¯Ø¹Ù… AdGem
app.get("/postback-adgem", async (req, res) => {
  const { playerid, amount, transaction_id } = req.query;

  console.log("ðŸ“© Postback received from AdGem:", req.query);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† IP Ø§Ù„Ù…ØµØ¯Ø±
  const clientIP = getCleanIp(req);
  if (!checkAllowedIP(clientIP, 'ADGEM')) {
    console.warn(`âŒ IP ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù€ AdGem: ${clientIP}`);
    return res.status(403).send("ØºÙŠØ± Ù…ØµØ±Ø­");
  }

  console.log(`âœ… IP Ù…Ø³Ù…ÙˆØ­ Ù„Ù€ AdGem: ${clientIP}`);

  if (!playerid || !amount) {
    console.warn("âŒ Missing playerid or amount");
    return res.status(400).send("Missing playerid or amount");
  }

  try {
    const db = admin.database();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
    if (transaction_id) {
      const existingTxRef = db.ref(`transactions/${transaction_id}`);
      const existingTx = await existingTxRef.once('value');
      
      if (existingTx.exists()) {
        console.log(`âš ï¸ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙƒØ±Ø±Ø©: ${transaction_id}`);
        return res.status(200).send("Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙƒØ±Ø±Ø© - ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§");
      }
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const userMappingsRef = db.ref('userMappings');
    const snapshot = await userMappingsRef.orderByChild('autoGeneratedId').equalTo(playerid).once('value');
    
    if (!snapshot.exists()) {
      console.warn(`âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: ${playerid}`);
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© pending Ø­ØªÙ‰ ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨
      if (transaction_id) {
        const pendingTxRef = db.ref(`pendingTransactions/${transaction_id}`);
        await pendingTxRef.set({
          transaction_id,
          playerid,
          amount,
          timestamp: Date.now(),
          status: "pending_user_linking",
          source: "adgem"
        });
        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ø§Ù…Ù„Ø© AdGem pending: ${transaction_id}`);
      }
      
      return res.status(404).send("User mapping not found");
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ
    let googleUserId = null;
    snapshot.forEach((childSnapshot) => {
      googleUserId = childSnapshot.key;
    });
    
    if (!googleUserId) {
      return res.status(404).send("Google user ID not found");
    }

    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„
    const userRef = db.ref(`users/${googleUserId}`);
    const pointsSnapshot = await userRef.child("points").once("value");
    const pointsToAdd = Math.round(parseFloat(amount) * 300); // Ù†ÙØ³ Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ MyLead
    const newPoints = (pointsSnapshot.val() || 0) + pointsToAdd;

    await userRef.update({ points: newPoints });

    console.log(`âœ… Added ${pointsToAdd} points to ${googleUserId} (Total: ${newPoints})`);

    // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ³ØªØ¨Ø§Ùƒ ÙÙŠ transactions
    const txId = transaction_id || "adgem_no_id_" + Date.now();
    const txRef = db.ref(`transactions/${txId}`);
    await txRef.set({
      transaction_id,
      playerid,
      amount,
      googleUserId,
      points: pointsToAdd,
      timestamp: Date.now(),
      status: "completed",
      ip: clientIP,
      source: "adgem"
    });

    console.log(`âœ… ØªÙ… ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø§Ù…Ù„Ø© AdGem: ${txId}`);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù†Ø§Ø¬Ø­ Ø¥Ù„Ù‰ AdGem
    res.status(200).send("OK");

  } catch (error) {
    console.error("âŒ AdGem Postback Error:", error);
    res.status(500).send("Error processing postback");
  }
});

// âœ… Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„
app.post("/link-account", async (req, res) => {
  try {
    const { autoGeneratedId, googleUserId } = req.body;
    
    if (!autoGeneratedId || !googleUserId) {
      return res.status(400).json({ error: "ÙŠØ¬Ø¨ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ø±ÙÙŠÙ† ØµØ§Ù„Ø­ÙŠÙ†" });
    }
    
    const db = admin.database();
    const userMappingsRef = db.ref('userMappings');
    
    // Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„
    await userMappingsRef.child(googleUserId).set({
      autoGeneratedId: autoGeneratedId,
      linkedAt: new Date().toISOString()
    });
    
    console.log(`âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ${autoGeneratedId} Ø¨Ù…Ø¹Ø±Ù Ø¬ÙˆØ¬Ù„ ${googleUserId}`);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† AdGem ÙˆMyLead)
    const pendingTxRef = db.ref('pendingTransactions');
    const pendingSnapshot = await pendingTxRef.orderByChild('autoUserId').equalTo(autoGeneratedId).once('value');
    
    let processedCount = 0;
    if (pendingSnapshot.exists()) {
      console.log(`ðŸ“‹ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${autoGeneratedId}`);
      
      const userRef = db.ref(`users/${googleUserId}`);
      const pointsSnapshot = await userRef.child("points").once("value");
      let currentPoints = pointsSnapshot.val() || 0;
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending
      const updates = {};
      pendingSnapshot.forEach((childSnapshot) => {
        const pendingTx = childSnapshot.val();
        const pointsToAdd = Math.round(parseFloat(pendingTx.payout || pendingTx.amount) * 300);
        currentPoints += pointsToAdd;
        
        // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¥Ù„Ù‰ transactions
        updates[`transactions/${pendingTx.transaction_id}`] = {
          ...pendingTx,
          googleUserId,
          points: pointsToAdd,
          processedAt: Date.now(),
          status: "completed_later"
        };
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† pending
        updates[`pendingTransactions/${pendingTx.transaction_id}`] = null;
        
        console.log(`âœ… ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© pending: ${pendingTx.transaction_id}`);
        processedCount++;
      });
      
      // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updates[`users/${googleUserId}/points`] = currentPoints;
      
      // ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
      await db.ref().update(updates);
      
      console.log(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${currentPoints - (pointsSnapshot.val() || 0)} Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending`);
    }
    
    res.status(200).json({ 
      success: true, 
      message: "ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­",
      pendingProcessed: processedCount
    });
  } catch (error) {
    console.error("âŒ Error linking account:", error);
    res.status(500).json({ 
      success: false, 
      message: "Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨" 
    });
  }
});

// âœ… Ù†Ù‚Ø·Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
app.get("/user/:userId", async (req, res) => {
  try {
    const { userId } = req.params;
    const db = admin.database();
    
    const userRef = db.ref(`users/${userId}`);
    const userData = await userRef.once('value');
    
    if (!userData.exists()) {
      return res.status(404).json({ error: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
    }
    
    res.json(userData.val());
  } catch (error) {
    console.error("âŒ Error fetching user data:", error);
    res.status(500).json({ error: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" });
  }
});

// âœ… Ù†Ù‚Ø·Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
app.get("/transactions", async (req, res) => {
  try {
    const db = admin.database();
    const transactionsRef = db.ref('transactions');
    const transactions = await transactionsRef.once('value');
    
    res.json(transactions.val() || {});
  } catch (error) {
    console.error("âŒ Error fetching transactions:", error);
    res.status(500).json({ error: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª" });
  }
});

// âœ… Ù†Ù‚Ø·Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending
app.get("/pending-transactions", async (req, res) => {
  try {
    const db = admin.database();
    const pendingRef = db.ref('pendingTransactions');
    const pending = await pendingRef.once('value');
    
    res.json(pending.val() || {});
  } catch (error) {
    console.error("âŒ Error fetching pending transactions:", error);
    res.status(500).json({ error: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª pending" });
  }
});

// âœ… Ù†Ù‚Ø·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
app.get("/health", (req, res) => {
  res.status(200).json({ 
    status: "OK", 
    message: "Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­",
    timestamp: new Date().toISOString()
  });
});

// âœ… Ù†Ù‚Ø·Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
app.get("/info", (req, res) => {
  res.json({
    myleadPostbackUrl: "https://freefire-points-new.onrender.com/postback?transaction_id=[transaction_id]&program_name=[program_name]&payout=[payout]&ml_sub1=[ml_sub1]",
    adgemPostbackUrl: "https://freefire-points-new.onrender.com/postback-adgem?playerid={player_id}&amount={amount}&transaction_id={transaction_id}",
    allowedIPs: ALLOWED_IPS,
    version: "1.1.0"
  });
});

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(port, () => {
  console.log(`ðŸš€ Server is running on port ${port}`);
  console.log(`ðŸ“Š Endpoints:`);
  console.log(`   - GET  /postback (MyLead Postback)`);
  console.log(`   - GET  /postback-adgem (AdGem Postback)`);
  console.log(`   - POST /link-account`);
  console.log(`   - GET  /user/:userId`);
  console.log(`   - GET  /transactions`);
  console.log(`   - GET  /pending-transactions`);
  console.log(`   - GET  /health`);
  console.log(`   - GET  /info`);
  console.log(`\nðŸ”— MyLead Postback URL:`);
  console.log(`   https://freefire-points-new.onrender.com/postback?transaction_id=[transaction_id]&program_name=[program_name]&payout=[payout]&ml_sub1=[ml_sub1]`);
  console.log(`\nðŸ”— AdGem Postback URL:`);
  console.log(`   https://freefire-points-new.onrender.com/postback-adgem?playerid={player_id}&amount={amount}&transaction_id={transaction_id}`);
});
