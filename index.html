<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>عروضي</title>
  <!-- مكتبات Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>عروض CPA</h1>

  <div id="user-info"></div>
  <button id="login-btn">تسجيل الدخول بحساب Google</button>

  <div id="points-count">نقاطك: 0</div>

  <div id="id-section" style="display:none;">
    <input type="text" id="user-id" placeholder="أدخل الآيدي الخاص بك">
    <button id="save-id">حفظ الآيدي</button>
  </div>

  <ul id="offers"></ul>
  <button onclick="notify()">أرسل إشعار تليغرام</button>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBSocmPYyRrVPFQIlk8UkHWxvPNIe1B1-A",
      authDomain: "freefirerewardsdz-69572.firebaseapp.com",
      databaseURL: "https://freefirerewardsdz-69572-default-rtdb.firebaseio.com",
      projectId: "freefirerewardsdz-69572",
      storageBucket: "freefirerewardsdz-69572.appspot.com",
      messagingSenderId: "145782934523",
      appId: "1:145782934523:web:76a2f7c4d2e37f94d6595e",
      measurementId: "G-JJ4BK2H8QY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUserUid = null;

    // زر تسجيل الدخول
    document.getElementById('login-btn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          currentUserUid = user.uid;
          document.getElementById('user-info').innerHTML = `مرحبًا، ${user.displayName}`;
          document.getElementById('id-section').style.display = "block";
          db.ref('users/' + user.uid).update({
            name: user.displayName,
            email: user.email
          });
          localStorage.setItem('uid', user.uid);
          loadPoints();
        })
        .catch(error => {
          console.error(error);
          alert('فشل تسجيل الدخول');
        });
    });

    // زر حفظ الآيدي
    document.getElementById('save-id').addEventListener('click', () => {
      const enteredId = document.getElementById('user-id').value.trim();
      if (!enteredId) {
        alert("أدخل الآيدي أولا");
        return;
      }
      if (!currentUserUid) {
        alert("سجل الدخول أولاً");
        return;
      }
      db.ref('users/' + currentUserUid).update({
        userId: enteredId
      });
      alert("تم حفظ الآيدي بنجاح");
    });

    // تحميل العروض
    async function loadOffers() {
      try {
        const res = await fetch('/api/offers');
        const offers = await res.json();
        const ul = document.getElementById('offers');
        ul.innerHTML = '';
        offers.slice(0, 10).forEach(o => {
          const li = document.createElement('li');
          li.innerHTML = `
            <a href="#" onclick="addPoints(${o.payout}, '${o.offer_url}')">${o.title}</a>
            - ${o.payout}$<br>
            ${o.description}
          `;
          ul.appendChild(li);
        });
      } catch (e) {
        console.error("خطأ تحميل العروض:", e);
      }
    }

    // إضافة النقاط
    function addPoints(payout, url) {
      if (!currentUserUid) {
        alert("سجل الدخول أولًا");
        return;
      }
      const pointsToAdd = Math.floor(payout * 300);
      const userRef = db.ref('users/' + currentUserUid + '/points');

      userRef.once('value').then(snapshot => {
        const currentPoints = snapshot.val() || 0;
        const newPoints = currentPoints + pointsToAdd;
        userRef.set(newPoints);
        alert(`تم إضافة ${pointsToAdd} نقطة. مجموع نقاطك: ${newPoints}`);
        document.getElementById('points-count').innerText = `نقاطك: ${newPoints}`;
        window.open(url, '_blank');
      });
    }

    // تحميل النقاط
    function loadPoints() {
      if (!currentUserUid) return;
      const userRef = db.ref('users/' + currentUserUid + '/points');
      userRef.once('value').then(snapshot => {
        const pts = snapshot.val() || 0;
        document.getElementById('points-count').innerText = `نقاطك: ${pts}`;
      });
    }

    // إرسال إشعار
    async function notify() {
      await fetch('/api/notify?message=شخص دخل على الموقع');
      alert("تم الإرسال");
    }

    loadOffers();
  </script>
</body>
</html>
