<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>عروضي</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>عروض CPA</h1>
  <div id="user-info"></div>
  <button id="login-btn">تسجيل الدخول بحساب Google</button>
  <ul id="offers"></ul>
  <button onclick="notify()">أرسل إشعار تليغرام</button>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBSocmPYyRrVPFQIlk8UkHWxvPNIe1B1-A",
      authDomain: "freefirerewardsdz-69572.firebaseapp.com",
      databaseURL: "https://freefirerewardsdz-69572-default-rtdb.firebaseio.com",
      projectId: "freefirerewardsdz-69572",
      storageBucket: "freefirerewardsdz-69572.firebasestorage.app",
      messagingSenderId: "145782934523",
      appId: "1:145782934523:web:76a2f7c4d2e37f94d6595e",
      measurementId: "G-JJ4BK2H8QY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // تسجيل الدخول
    document.getElementById('login-btn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          document.getElementById('user-info').innerHTML = `مرحبًا، ${user.displayName}`;
          // حفظ الـ UID في قاعدة البيانات
          db.ref('users/' + user.uid).set({
            name: user.displayName,
            email: user.email
          });
          // تخزين الـ UID محليًا
          localStorage.setItem('uid', user.uid);
        })
        .catch(error => {
          console.error(error);
          alert('فشل تسجيل الدخول');
        });
    });

    // تحميل العروض
    async function loadOffers() {
      const res = await fetch('/api/offers');
      const offers = await res.json();
      const ul = document.getElementById('offers');
      ul.innerHTML = '';
      offers.slice(0, 10).forEach(o => {
        const li = document.createElement('li');
        li.innerHTML = `
          <a href="${o.offer_url}" target="_blank">${o.title}</a>
          - ${o.payout}$ <br>
          ${o.description}
        `;
        ul.appendChild(li);
      });
    }

    async function notify() {
      await fetch('/api/notify?message=شخص دخل على الموقع');
      alert("تم الإرسال");
    }

    loadOffers();
  </script>
</body>
</html>
